# ==============================================================================
# Edge Tier — Edge Engine(s) Only
# ==============================================================================
# Machine C: One or more Edge Engine instances
#
# Usage:
#   docker-compose -f docker-compose.edge-tier.yml --env-file .env.distributed up -d
# ==============================================================================

services:
  edge:
    build:
      context: ../services/edge
      dockerfile: Dockerfile
    ports:
      - "${EDGE_PORT:-3002}:3002"
    environment:
      - NODE_ENV=production
      - PORT=3002
      - FRONTBASE_ENV=${FRONTBASE_ENV:-local}
      - SQLITE_PATH=/app/data/edge.db
      - DATABASE_URL=file:/app/data/edge.db
      - PAGES_DB_URL=${PAGES_DB_URL:-file:/app/data/pages.db}
      # Backend URL — point to Machine A
      - FASTAPI_URL=${FASTAPI_URL:-http://backend:8000}
      # Turso (for FRONTBASE_ENV=cloud)
      - FRONTBASE_STATE_DB_URL=${TURSO_DB_URL:-}
      - FRONTBASE_STATE_DB_TOKEN=${TURSO_DB_TOKEN:-}
      # Upstash (for FRONTBASE_ENV=cloud)
      - FRONTBASE_REDIS_URL=${UPSTASH_REDIS_URL:-}
      - FRONTBASE_REDIS_TOKEN=${UPSTASH_REDIS_TOKEN:-}
      - API_KEYS=${API_KEYS:-}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET:-}
      - PUBLIC_URL=${PUBLIC_URL:-}
    volumes:
      - edge_data:/app/data
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3002/api/health" ]
      interval: 15s
      timeout: 5s
      retries: 3

volumes:
  edge_data:
